---
title: 'Integrating CloudHealth with OpenOps'
description: "Acting on CloudHealth's rightsizing recommendations in an OpenOps workflow"
icon: 'heart-pulse'
---

CloudHealth is a cloud cost management and optimization platform that helps companies manage their multi-cloud environments consisting of AWS, Azure, Google Cloud, private and hybrid cloud setups.

CloudHealth provides cost visibility, allocation, and optimization, suggesting actions like rightsizing, reserved instance purchases, and idle resource cleanup.

While CloudHealth is great at analysis and reporting, it’s not really built to orchestrate automation across teams. That's what OpenOps does best, and integrating the two is a great way to get the best of both worlds. Let CloudHealth find issues, and OpenOps act on them, triggering workflows, automations, and notifications.

## What this tutorial will cover

This tutorial guides you step-by-step to create two workflows in OpenOps:
1. The first workflow, "Fill the Project-Owner mapping table", fetches all project names from AWS instance metadata stored in CloudHealth, and writes them to an OpenOps table. Once this is done, you should go through the table and enter real emails of project owners. This assumes that in your organization, cloud resource ownership is allocated on a per-project basis.
2. The second workflow, "CloudHealth Rightsizing Recommendations", fetches AWS EC2 rightsizing recommendations from CloudHealth, looks up owners of projects they fall into, notifies owners via Slack, and implements resolutions from owners by creating Jira tickets, snoozing, or dismissing recommendations.

Here's the outline of the two OpenOps workflows that you're going to build:

> TODO update the below, outline the second workflow
1. Trigger: run every day at midnight UTC, excluding weekends.
2. Get rightsizing recommendations from CloudHealth for AWS EC2 instances from the last 7 days, limited to three recommendations.
3. Loop over the list of rightsizing recommendations returned. For each recommendation:
    1. Fetch asset perspectives from CloudHealth for the target AWS instance.
    2. Query the "Project perspective owners" OpenOps table to get owner information based on the project perspective.
    3. Format the projected monthly savings value to 2 decimal places.
    4. Run custom code to extract the AWS region from the instance DNS.
    5. Send a Slack message to the owner with the rightsizing opportunity details and three action buttons: "Open Jira ticket", "Snooze", "Exempt".
    6. Act depending on which Slack action the owner selected:
        1. If "Open Jira ticket":
            1. Create a Jira issue for the opportunity.
            2. Send a Slack confirmation message.
        2. If "Snooze":
            1. Get the date of the next Monday.
            2. Update the opportunity status to "Snoozed" with the snooze date set to next Monday.
        3. If "Exempt": tag the asset as exempt in CloudHealth.

## Prerequisites

You will need a CloudHealth account configured to provide recommendations for AWS EC2 instances.

On several steps of the tutorial, you'll also need to create OpenOps connections to several services:
- **CloudHealth**: API credentials to access CloudHealth data.
- **Slack**: Bot token with permissions to send messages and request actions.
- **Jira**: API credentials with permissions to create issues.

## Creating a workflow to fill the project-owner mapping table

The first workflow that you're going to build will help track resource ownership by project. For this workflow to operate, it needs an OpenOps table to store project information. Let's create the table first.

### Create a project-owner mapping table

To create the table that will store project names and their owners, follow these steps:

1. On the left-side OpenOps menu bar, click **Tables**.
2. Under the **Tables** heading, click **OpenOps Dataset** to expand the list of tables.
3. At the bottom of the list, click **New table**.
4. In the **Name** textbox, enter _CloudHealth project-owner mapping_.
5. Click **Add table**.
6. When the new table is created, it has a few default fields (a _field_ in OpenOps tables is what we typically call a column). You won't need them; instead, create two new fields. Start with a field for the project name:
    1. Click **+** in the table header to create a new field.
    2. In the list of field data types, click **Single line text**.
    3. Replace the default name of the field with _CloudHealth project_.
    4. Click **Create**.
7. Create a second field for the owner email:
     1. Click **+** in the table header to create a new field.
     2. In the list of field data types, click **Email**.
     3. Replace the default name of the field with _Owner email_.
8. Now, make _CloudHealth project_ the primary field:
    1. Click the down arrow in the header of the **Name** field that was created by default.
    2. Click **Change primary field**.
    3. In the **Primary field** dropdown, select _CloudHealth project_.
    4. Click **Change**.
9. Delete the three default fields: **Name**, **Notes**, and **Active**. For each of these fields, click the down arrow in the header, then click **Delete field**.

The resulting project-owner mapping table should look like this:

![A ready to use project-owner mapping table](/images/cloudhealth/project-owner-mapping/mapping-table.png)

### Create a new workflow

Now that you've prepared a project-owner mapping table, you can start creating a workflow that takes advantage of it.

On the left-side OpenOps menu bar, click **Workflows**. When the list of workflows opens, click the **+ New Workflow** button on the top right.

OpenOps will open its workflow editor with a new untitled workflow that initially only contains an empty trigger step:

![A new workflow in OpenOps](/images/cloudhealth/project-owner-mapping/empty-workflow.png)

On the top left, click the down arrow next to the workflow name, then click **Rename**, and rename the workflow to _Fill the Project-Owner mapping table_.

### Configure the trigger to run every week

The first thing that needs to be done is to configure your workflow to run on a schedule.

In the workflow editor, click the trigger step. When a drop-down with types of triggers opens, select **Schedule**, then **Every Week**.

After selecting the trigger type and frequency, you will see the trigger step's properties pane on the right, with the **Configure** tab open. Under **Day of the week**, select **Monday**. Under **Hour of the day**, select **Noon**. Keep the default time zone (UTC) or set it to the time zone you're in.

Now, open the **Test** tab in the properties pane. There, under **Step output**, click **Load Data**. This way, you're testing your step, and going forward, you'll need to test all steps before you can test the entire workflow. While in the case of a trigger this looks more like a formality, in many cases testing individual steps will help you spot and fix configuration errors quickly.

Here's what your workflow should look like at this point:

![A configured and tested trigger](/images/cloudhealth/project-owner-mapping/trigger-added.png)

### Get all AWS instances from CloudHealth

The goal of this workflow is to get all project names from AWS instance metadata stored in CloudHealth, and write them to an OpenOps table. This way, the EC2 rightsizing workflow can look up project owners based on project names.

Therefore, the first action of this workflow is to fetch information about all AWS instances from CloudHealth.

In the workflow graph, under the trigger, click **+** to add a new step.

In the pop-up menu, scroll down to and click **CloudHealth**. In the list of CloudHealth-related actions, select **Search Assets**:

![Selecting a CloudHealth action](/images/cloudhealth/selecting-cloudhealth-action.png)

This adds a new step to the workflow graph and displays the action's properties pane on the right. You'll now need to configure the action.

First, at the very top of the properties pane, click **Edit Step Name** next to the default name, and rename the step to _Get all AWS instances_.

Then, under **API Key**, click **Select a connection**, then **Create Connection**. This will open a new dialog that looks like this:

![Creating a CloudHealth connection](/images/cloudhealth/create-cloudhealth-connection.png)

In the dialog, you need to enter your CloudHealth API key. If you don't have it at hand, follow the instructions in the dialog to generate an API key. Once you have the key, paste it into the **API Key** field and click **Save**.

After the dialog closes, back in the properties pane, set **Asset Type** to **AWSInstance**.

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. This will test the action and display its output.

Your workflow should now look like this:

![A configured CloudHealth action](/images/cloudhealth/project-owner-mapping/cloudhealth-action-added.png)

### Extract distinct project names

Now that you have a list of all AWS instances, you need to know all projects they belong to. For this, let's create a JavaScript code block that goes through metadata of all instances, extracts project names, and returns a list of distinct project names.

In the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Code** in the left pane, then click **Custom TypeScript Code** in the right pane. This adds a new step to the workflow graph and displays the code block's properties pane on the right.

At the top of the properties pane, click **Edit Step Name** and rename the step to _Extract distinct project names_.

Next, you need to let the custom code action know exactly what data it needs to process. Under **Inputs** in the properties pane, click **Add Item**, which will display two new fields. Enter _instances_ in the left field. When you click in the right field, the **Data Selector** view opens. Inside that view, click **Insert** alongside the **Get all AWS instances** entry:

![Selecting an input for a code action](/images/cloudhealth/project-owner-mapping/code-block-data-selector.png)

This will make sure that the code action gets the list of instances as an input.

Next, inside the **Code** editor field, replace the placeholder with the following JavaScript code snippet:

```javascript
export const code = async (inputs) => {
    const projectsOnly = inputs.instances.map(item => {
        const match = item.groups.match(/Project:\s*([^,]+)/);
        const project = match ? match[1].trim() : null;
        return project;
    })
    return [...new Set(projectsOnly)];
};
```

This is what the **Configure** tab in the properties pane should now look like:

![A configured custom code step](/images/cloudhealth/project-owner-mapping/code-block-configure.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. After testing, you should see an array containing all project names in the **Output** area:

![Testing the custom code step](/images/cloudhealth/project-owner-mapping/code-block-testing.png)

### Add all project names to the OpenOps table

Now that you have a list of all project names, you need to add them to the OpenOps table. This can be done with two actions: one to loop over the list of project names, and another to add each project name to the table.

First, click **+** in the workflow editor to add a new step.

In the pop-up menu, select **Loop on Items** in the left pane, then click **Loop on Items** in the right pane.

In the new loop step's properties pane, rename the step to _For each project name_.

Click in the **Items** field. In the **Data Selector** view that opens, click **Insert** alongside the **3. Extract distinct project names** entry. This passes the list of project names obtained in the previous step as the input for the loop to iterate over.

This is what the **Configure** tab in the properties pane should now look like:

![A configured loop step](/images/cloudhealth/project-owner-mapping/loop-added.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. The test output should be an object representing the first item in the list of project names:

```json
{
  "item": "Other",
  "index": 1
}
```

Now, in the workflow editor, click the **+** button _inside_ the loop:

![Creating a step inside a loop](/images/cloudhealth/project-owner-mapping/new-step-inside-loop.png)

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Add or Update Record** in the right pane.

In the properties pane of the new step, rename the step to _Add project to mapping table_.

For the **Table** field, select **CloudHealth project-owner mapping** — that's the table you created manually earlier.

Click the **Primary Key Value** field to display the **Data Selector** view. Inside that view, expand the **4. For each project name** entry, then click **Insert** alongside the **item** entry:

![Selecting the project name to add to the table](/images/cloudhealth/project-owner-mapping/table-pkv-data-selector.png)

Under **Fields to update**, click **Add Item**. This will open a new area that lets you specify what to add in the **Owner email** field of your OpenOps table. Inside the area:
* In the **Field name** dropdown, select **Owner email**.
* In the **Owner email** field, enter an email placeholder like `replace@this.email` or your own email. Once this workflow has been run, you will need to replace this placeholder with actual emails of each project's owner.

Here's what the **Configure** tab in the properties pane should now look like:

![A configured table step](/images/cloudhealth/project-owner-mapping/table-step-added.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. After testing, the output is a JSON object that represents the new row added to the table:

```json
{
  "id": 3,
  "order": "3.00000000000000000000",
  "CloudHealth project": "Other",
  "Owner email": "replace@this.email"
}
```

### Test the workflow



## Creating a workflow to process CloudHealth rightsizing recommendations

### Create a new workflow

In your OpenOps instance, click the **+ New Workflow** button on the top right.

When the OpenOps workflow editor opens with a new workflow, click the down arrow next to the workflow name on the top left, then click **Rename**, and rename the workflow to _CloudHealth Rightsizing Recommendations_.

### Configure the trigger to run every working day

In the workflow editor, click the trigger step. When a drop-down with types of triggers opens, select **Schedule**, then **Every Day**.

In the trigger step's properties pane on the right, in the **Configure** tab, keep the defaults. With the default trigger settings, your workflow will run every day, excluding weekends, at midnight UTC.

Now, open the **Test** tab, and under **Step output**, click **Load Data**.

Here's what your workflow should look like at this point:

![A configured and tested trigger](/images/cloudhealth/trigger-added.png)

### Fetch rightsizing recommendations from CloudHealth

Now is the time to add the first action step. Since the workflow is centered around processing recommendations from CloudHealth, let's start with that.

In the workflow graph, under the trigger, click the **+** button to add a new step.

In the pop-up menu, scroll down to and click **CloudHealth**. In the list of CloudHealth-related actions, select **Get Recommendations**:

![Selecting a CloudHealth action](/images/cloudhealth/selecting-cloudhealth-action.png)

This adds a new step to the workflow graph and displays the action's properties pane on the right. You'll now need to configure the action.

First, in the properties pane, under **API Key**, select your existing CloudHealth connection that you set up when working on the project-mapping workflow.

Then, configure the remaining action properties like this:
* Under **Recommendation Type**, select **EC2 Rightsizing**.
* Under **Evaluation Duration**, select **Last 7 Days**.
* Under **Limit**, set the value to `3` to retrieve the top 3 recommendations.

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. This will test the action and display the results in the bottom right pane.

Your workflow should now look like this:

![A configured CloudHealth action](/images/cloudhealth/cloudhealth-action-added.png)

### Loop over recommendations

CloudHealth returns a list of recommendations, but we only want to process one at a time. To do this, let's use a **Loop on Items** block.

In the workflow graph, click the **+** button to add a new step.

In the pop-up menu, select **Loop on Items** in the left pane, then click **Loop on Items** in the right pane. This adds a new step to the workflow graph and displays the loop's properties pane on the right.

In the properties pane, click the **Items** field. In the **Data Selector** view that opens, expand the **2. Get Recommendations** entry, then expand **rightsizingRecommendations**, and click **Insert** alongside the **edges** entry:

![Selecting items to loop over](/images/cloudhealth/data-selector-edges.png)

This will add the **edges** entry to the **Items** field in the properties pane, ensuring that OpenOps loops over this particular array in the list of CloudHealth recommendations.

In the properties pane, under **Step output**, click **Test Step**. After testing, your workflow should look like this:

![A configured Loop on Items block](/images/cloudhealth/loop-added.png)

All further steps in this workflow will be added inside this loop.

#### Get asset perspectives from CloudHealth

- Inside the loop, add a **Block** with `@openops/block-cloudhealth`.
- Use the action `cloudhealth_get_asset_perspectives`.
- Input:
  - `auth`: CloudHealth connection.
  - `assetType`: `AwsInstance`.
  - `fields`: Pass the instance ID from the current item: `{{step_2['item']['node']['targetAsset']['awsInstanceId']}}`.
- This enriches the recommendation with asset metadata and perspectives.

#### Query project owner from an OpenOps table

- Add a **Block** with `@openops/block-openops-tables`.
- Use the action `get_records`.
- Configure inputs:
  - `tableName`: `Project perspective owners`.
  - `filters`: Filter by project name equal to `{{step_13[0]['perspectives']['Project']}}`.
- This fetches the owner email and other details for the project.

#### Format projected monthly savings

- Add a **Block** with `@openops/block-math-helper`.
- Use the action `truncate_math`.
- Input:
  - `number`: `{{step_2['item']['node']['projectedMonthlySavings']}}`.
  - `numberOfDecimalPlaces`: `2`.
- This formats the savings value for display.

#### Extract AWS region from DNS

- Add a **Code** block.
- Input:
  - `dns`: `{{step_13[0]['asset']['dns']}}`.
- Use this JavaScript code to extract the AWS region from the DNS string:

```javascript
export const code = async (inputs) => {
  const dns = typeof inputs['dns'] === 'string' ? inputs['dns'] : '';
  const parts = dns.split('.');
  const region = parts.length > 1 ? parts[1] : '';
  return region;
};
```

#### Send a Slack notification

- Add a **Block** with `@openops/block-slack`.
- Use the action `request_action_message`.
- Configure inputs:
  - `auth`: Slack connection.
  - `text`: Compose a message including:
    - Account name
    - Instance ID and name
    - Projected monthly savings
    - Owner email
    - Cost center perspective
    - Link to CloudHealth resource details
  - Include action buttons:
    - Open JIRA ticket (primary)
    - Snooze for 7 days
    - Exempt (danger)
  - Set `timeoutInDays` to 3.
  - Provide a Slack conversation ID for responses.
- This notifies the owner and collects their response.

#### Handle Slack action with a split block

- Add a **Split** block to branch based on Slack action:
  - **JIRA branch**:
    - Add a **Block** with `@openops/block-jira-cloud`.
    - Use `create_issue` action.
    - Configure issue details with opportunity info.
    - Follow with a Slack message confirming issue creation.
  - **Snooze branch**:
    - Add a **Block** with `@openops/block-date-helper`.
    - Use `next_day_of_week` to calculate next Monday.
    - Update the `Opportunities` table record to set status to "Snoozed" and snooze date.
  - **Dismiss branch**:
    - Add a **Block** with `@openops/block-cloudhealth`.
    - Update the `Opportunities` table record to set status to "Dismissed".

##### Jira

##### Snooze

##### Dismiss
