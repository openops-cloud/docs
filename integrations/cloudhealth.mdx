---
title: 'Integrating CloudHealth with OpenOps'
description: "Acting on CloudHealth's rightsizing recommendations in an OpenOps workflow"
icon: 'heart-pulse'
---

CloudHealth is a cloud cost management and optimization platform that helps companies manage their multi-cloud environments consisting of AWS, Azure, Google Cloud, private and hybrid cloud setups.

CloudHealth provides cost visibility, allocation, and optimization, suggesting actions like rightsizing, reserved instance purchases, and idle resource cleanup.

While CloudHealth is great at analysis and reporting, it’s not really built to orchestrate automation across teams. That's what OpenOps does best, and integrating the two is a great way to get the best of both worlds. Let CloudHealth find issues, and OpenOps act on them, triggering workflows, automations, and notifications.

## What this tutorial will cover

This tutorial guides you step-by-step to create two workflows in OpenOps:
1. The first workflow, "Fill the Project-Owner mapping table", fetches all project names from AWS instance metadata stored in CloudHealth, and writes them to an OpenOps table. This assumes that in your organization, cloud resource ownership is allocated on a per-project basis.
2. The second workflow, "CloudHealth Rightsizing Recommendations", fetches AWS EC2 rightsizing recommendations from CloudHealth, looks up owners of projects they fall into, notifies owners via Slack, and implements resolutions from owners by creating Jira tickets, snoozing, or dismissing recommendations.

Here's the outline of the two OpenOps workflows that you're going to build:

> TODO update the below, outline the second workflow
1. Trigger: run every day at midnight UTC, excluding weekends.
2. Get rightsizing recommendations from CloudHealth for AWS EC2 instances from the last 7 days, limited to three recommendations.
3. Loop over the list of rightsizing recommendations returned. For each recommendation:
    1. Fetch asset perspectives from CloudHealth for the target AWS instance.
    2. Query the "Project perspective owners" OpenOps table to get owner information based on the project perspective.
    3. Format the projected monthly savings value to 2 decimal places.
    4. Run custom code to extract the AWS region from the instance DNS.
    5. Send a Slack message to the owner with the rightsizing opportunity details and three action buttons: "Open Jira ticket", "Snooze", "Exempt".
    6. Act depending on which Slack action the owner selected:
        1. If "Open Jira ticket":
            1. Create a Jira issue for the opportunity.
            2. Send a Slack confirmation message.
        2. If "Snooze":
            1. Get the date of the next Monday.
            2. Update the opportunity status to "Snoozed" with the snooze date set to next Monday.
        3. If "Exempt": tag the asset as exempt in CloudHealth.

## Prerequisites

You will need a CloudHealth account configured to provide recommendations for AWS EC2 instances.

On several steps of the tutorial, you'll also need to create OpenOps connections to several services:
- **CloudHealth**: API credentials to access CloudHealth data.
- **Slack**: Bot token with permissions to send messages and request actions.
- **Jira**: API credentials with permissions to create issues.

## Creating a workflow to fill the project-owner mapping table

The first workflow that you're going to build will help track resource ownership by project. For this workflow to operate, it needs an OpenOps table to store project information. Let's create the table first.

### Create a project-owner mapping table

To create the table that will store project names and their owners, follow these steps:

1. On the left-side OpenOps menu bar, click **Tables**.
2. Under the **Tables** heading, click **OpenOps Dataset** to expand the list of tables.
3. At the bottom of the list, click **New table**.
4. In the **Name** textbox, enter _CloudHealth project-owner mapping_.
5. Click **Add table**.
6. When the new table is created, it has a few default fields (a _field_ in OpenOps tables is what we typically call a column). You won't need them; instead, create two new fields. Start with a field for the project name:
    1. Click **+** in the table header to create a new field.
    2. In the list of field data types, click **Single line text**.
    3. Replace the default name of the field with _CloudHealth project_.
    4. Click **Create**.
7. Create a second field for the owner email:
     1. Click **+** in the table header to create a new field.
     2. In the list of field data types, click **Email**.
     3. Replace the default name of the field with _Owner email_.
8. Now, make _CloudHealth project_ the primary field:
    1. Click the down arrow in the header of the **Name** field that was created by default.
    2. Click **Change primary field**.
    3. In the **Primary field** dropdown, select _CloudHealth project_.
    4. Click **Change**.
9. Delete the three default fields: **Name**, **Notes**, and **Active**. For each of these fields, click the down arrow in the header, then click **Delete field**.

The resulting project-owner mapping table should look like this:

![A ready to use project-owner mapping table](/images/cloudhealth/project-owner-mapping/mapping-table.png)

### Create a new workflow

Now that you've prepared a project-owner mapping table, you can start creating a workflow that takes advantage of it.

On the left-side OpenOps menu bar, click **Workflows**. When the list of workflows opens, click the **+ New Workflow** button on the top right.

OpenOps will open its workflow editor with a new untitled workflow that initially only contains an empty trigger step:

![A new workflow in OpenOps](/images/cloudhealth/project-owner-mapping/empty-workflow.png)

On the top left, click the down arrow next to the workflow name, then click **Rename**, and rename the workflow to _Fill the Project-Owner mapping table_.

### Configure the trigger to run every week

The first thing that needs to be done is to configure your workflow to run on a schedule.

In the workflow editor, click the trigger step. When a drop-down with types of triggers opens, select **Schedule**, then **Every Week**.

After selecting the trigger type and frequency, you will see the trigger step's properties pane on the right, with the **Configure** tab open. Under **Day of the week**, select **Monday**. Under **Hour of the day**, select **Noon**. Keep the default time zone (UTC) or set it to the time zone you're in.

Now, open the **Test** tab in the properties pane. There, under **Step output**, click **Load Data**. This way, you're testing your step, and going forward, you'll need to test all steps before you can test the entire workflow. While in the case of a trigger this looks more like a formality, in many cases testing individual steps will help you spot and fix configuration errors quickly.

Here's what your workflow should look like at this point:

![A configured and tested trigger](/images/cloudhealth/project-owner-mapping/trigger-added.png)

### Get all AWS instances from CloudHealth

The goal of this workflow is to get all project names from AWS instance metadata stored in CloudHealth, and write them to an OpenOps table. This way, the EC2 rightsizing workflow can look up project owners based on project names.

Therefore, the first action of this workflow is to fetch information about all AWS instances from CloudHealth.

In the workflow graph, under the trigger, click **+** to add a new step.

In the pop-up menu, scroll down to and click **CloudHealth**. In the list of CloudHealth-related actions, select **Search Assets**:

![Selecting a CloudHealth action](/images/cloudhealth/selecting-cloudhealth-action.png)

This adds a new step to the workflow graph and displays the action's properties pane on the right. You'll now need to configure the action.

First, at the very top of the properties pane, click **Edit Step Name** next to the default name, and rename the step to _Get all AWS instances_.

Then, under **API Key**, click **Select a connection**, then **Create Connection**. This will open a new dialog that looks like this:

![Creating a CloudHealth connection](/images/cloudhealth/create-cloudhealth-connection.png)

In the dialog, you need to enter your CloudHealth API key. If you don't have it at hand, follow the instructions in the dialog to generate an API key. Once you have the key, paste it into the **API Key** field and click **Save**.

After the dialog closes, back in the properties pane, set **Asset Type** to **AWSInstance**.

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. This will test the action and display its output.

Your workflow should now look like this:

![A configured CloudHealth action](/images/cloudhealth/project-owner-mapping/cloudhealth-action-added.png)

### Extract distinct project names

Now that you have a list of all AWS instances, you need to know all projects they belong to. For this, let's create a JavaScript code block that goes through metadata of all instances, extracts project names, and returns a list of distinct project names.

In the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Code** in the left pane, then click **Custom TypeScript Code** in the right pane. This adds a new step to the workflow graph and displays the code block's properties pane on the right.

At the top of the properties pane, click **Edit Step Name** and rename the step to _Extract distinct project names_.

Next, you need to let the custom code action know exactly what data it needs to process. Under **Inputs** in the properties pane, click **Add Item**, which will display two new fields. Enter _instances_ in the left field. When you click in the right field, the **Data Selector** view opens. Inside that view, click **Insert** alongside the **Get all AWS instances** entry:

![Selecting an input for a code action](/images/cloudhealth/project-owner-mapping/code-block-data-selector.png)

This will make sure that the code action gets the list of instances as an input.

Next, inside the **Code** editor field, replace the placeholder with the following JavaScript code snippet:

```javascript
export const code = async (inputs) => {
    const projectsOnly = inputs.instances.map(item => {
        const match = item.groups.match(/Project:\s*([^,]+)/);
        const project = match ? match[1].trim() : null;
        return project;
    })
    return [...new Set(projectsOnly)];
};
```

This is what the **Configure** tab in the properties pane should now look like:

![A configured custom code step](/images/cloudhealth/project-owner-mapping/code-block-configure.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. After testing, you should see an array containing all project names in the **Output** area:

![Testing the custom code step](/images/cloudhealth/project-owner-mapping/code-block-testing.png)

### Add all project names to the OpenOps table

Now that you have a list of all project names, you need to add them to the OpenOps table. This can be done with two actions: one to loop over the list of project names, and another to add each project name to the table.

First, click **+** in the workflow editor to add a new step.

In the pop-up menu, select **Loop on Items** in the left pane, then click **Loop on Items** in the right pane.

In the new loop step's properties pane, rename the step to _For each project name_.

Click in the **Items** field. In the **Data Selector** view that opens, click **Insert** alongside the **3. Extract distinct project names** entry. This passes the list of project names obtained in the previous step as the input for the loop to iterate over.

This is what the **Configure** tab in the properties pane should now look like:

![A configured loop step](/images/cloudhealth/project-owner-mapping/loop-added.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. The test output should be an object representing the first item in the list of project names:

```json
{
  "item": "Other",
  "index": 1
}
```

Now, in the workflow editor, click the **+** button _inside_ the loop:

![Creating a step inside a loop](/images/cloudhealth/project-owner-mapping/new-step-inside-loop.png)

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Add or Update Record** in the right pane.

In the properties pane of the new step, rename the step to _Add project to mapping table_.

For the **Table** field, select **CloudHealth project-owner mapping** — that's the table you created manually earlier.

Click the **Primary Key Value** field to display the **Data Selector** view. Inside that view, expand the **4. For each project name** entry, then click **Insert** alongside the **item** entry:

![Selecting the project name to add to the table](/images/cloudhealth/project-owner-mapping/table-pkv-data-selector.png)

Under **Fields to update**, click **Add Item**. This will open a new area that lets you specify what to add in the **Owner email** field of your OpenOps table. Inside the area:
* In the **Field name** dropdown, select **Owner email**.
* In the **Owner email** field, enter your own email as you'll be using it to test the EC2 rightsizing workflow described next. Your account in your organization's Slack workspace should be registered to this email. Once both workflows described in this tutorial are ready, you will replace your email with emails of the actual project owners.

Here's what the **Configure** tab in the properties pane should now look like:

![A configured table step](/images/cloudhealth/project-owner-mapping/table-step-added.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. After testing, the output is a JSON object that represents the new row added to the table:

```json
{
  "id": 1,
  "order": "1.00000000000000000000",
  "CloudHealth project": "Other",
  "Owner email": "your@email.here"
}
```

### Test and publish the workflow

These are all the steps you need to fill the project-owner mapping table. All you need to do now is to test and publish the workflow.

To test the workflow, scroll the workflow graph all the way up and click the **Test Workflow** button above the trigger:

![Test workflow](/images/cloudhealth/project-owner-mapping/test-workflow.png)

Even though this is called "testing", OpenOps will actually run the entire workflow, doing everything it would do if it was run on a schedule. Once the run completes, you should see green checkmarks next to each step in the **Run Details** pane on the right, as well as a **Run Succeeded** status message at the bottom:

![Workflow tested successfully](/images/cloudhealth/project-owner-mapping/workflow-tested.png)

Click **Edit** in the top right to get back to the workflow editor. Then, click **Publish** in the same top right corner to get the workflow live.

Once you do, the workflow will run on a schedule you've defined, which is every Monday at noon UTC.

If you click **Workflows** in the left-side menu, you should see the workflow you just published. All its runs will be listed in the view that you can open by clicking **Runs** in the left-side menu.

### Review the project-owner mapping table

Click **Tables** in the left-side menu. In the list of tables under **OpenOps Dataset**, click **CloudHealth project-owner mapping**. After running the workflow, the table should look something like this:

![Project-owner mapping table](/images/cloudhealth/project-owner-mapping/table-filled.png)

You now have all you need to start creating the second workflow.

## Creating a workflow to process CloudHealth rightsizing recommendations

Let's now create another workflow that will actually process CloudHealth EC2 rightsizing recommendations.

### Create a new workflow

In the **Overview** or **Workflows** view in OpenOps, click the **+ New Workflow** button on the top right.

When the OpenOps workflow editor opens with a new workflow, click the down arrow next to the workflow name on the top left, then click **Rename**, and rename the workflow to _CloudHealth Rightsizing Recommendations_.

### Configure the trigger to run every working day

In the workflow editor, click the trigger step. When a drop-down with types of triggers opens, select **Schedule**, then **Every Day**.

In the trigger step's properties pane on the right, in the **Configure** tab, keep the defaults. With the default trigger settings, your workflow will run every day, excluding weekends, at midnight UTC:

![A configured and tested trigger](/images/cloudhealth/trigger-added.png)

Now, open the **Test** tab in the properties pane, and under **Step output**, click **Load Data**. Remember that it's important to test every step of your workflow: testing all previous steps enables you to test every subsequent step and, later, the entire workflow.

### Fetch rightsizing recommendations from CloudHealth

Now is the time to add the first action step. Since the workflow is centered around processing recommendations from CloudHealth, let's start with that.

In the workflow graph, under the trigger, click the **+** button to add a new step.

In the pop-up menu, scroll down to and click **CloudHealth**. In the list of CloudHealth-related actions, select **Get Recommendations**:

![Selecting a CloudHealth action](/images/cloudhealth/selecting-cloudhealth-action.png)

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Get EC2 rightsizing recommendations_.

Under **API Key** in the properties pane, select your existing CloudHealth connection that you set up earlier when working on the project-mapping workflow.

Then, configure the remaining action properties like this:
* Under **Recommendation Type**, select **EC2 Rightsizing**.
* Under **Evaluation Duration**, select **Last 7 Days**.
* Under **Limit**, set the value to `3` to retrieve the top 3 recommendations. This should be enough for testing purposes. Later on, when you've completed this tutorial, feel free to increase this value or set this field empty to fetch all available recommendations.

Your workflow should now look like this:

![A configured CloudHealth action](/images/cloudhealth/cloudhealth-action-added.png)

Click the **Test** tab in the properties pane. Under **Step output**, click **Test Step**. This will test the action and display its output in the bottom right pane. Since the action returns a list of recommendations, expect to see JSON output like this:

```json
{
  "rightsizingRecommendations": {
    "edges": [
      {
        "node": {
          "targetAsset": { ... },
          "currentMetrics": [ ... ],
          "currentUtilizationStatus": "UNDER_TARGET",
          "options": [ ... ],
          "currentMonthlyPrice": 112.96,
          "projectedMonthlyPrice": 66.48167,
          "projectedMonthlySavings": 46.478333,
          "currentCost": 67.77599,
          "projectedCost": 66.48167,
          "projectedSavingsByCost": 1.2943289,
          "terminateRecommendation": false,
          "__typename": "RightsizingRecommendation"
        },
        "__typename": "RightsizingRecommendationEdge"
      },
      ... more nodes
    ],
    "utilizationStatusSummary": { ... },
    "pageInfo": { ... },
    "totalCount": 18,
    "__typename": "RightsizingRecommendationConnection"
  }
}
```

### Loop over recommendations

CloudHealth returns a list of recommendations, but we only want to process one at a time. To do this, let's use a **Loop on Items** action.

In the workflow graph, click the **+** button to add a new step.

In the pop-up menu, select **Loop on Items** in the left pane, then click **Loop on Items** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _For each recommendation_.

In the properties pane, click the **Items** field. In the **Data Selector** view that opens, expand the **2. Get EC2 rightsizing recommendations** entry, then expand **rightsizingRecommendations**, and click **Insert** alongside the **edges** entry:

![Selecting items to loop over](/images/cloudhealth/data-selector-edges.png)

This will add the **edges** entry to the **Items** field in the properties pane, ensuring that OpenOps loops over this particular array in the list of CloudHealth recommendations.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured Loop on Items block](/images/cloudhealth/loop-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output should be a JSON object representing the first rightsizing recommendation:

```json
{
  "item": {
    "node": {
      "targetAsset": { ... },
      "currentMetrics": [ ... ],
      "currentUtilizationStatus": "UNDER_TARGET",
      "options": [ ... ],
      "currentMonthlyPrice": 112.96,
      "projectedMonthlyPrice": 66.48167,
      "projectedMonthlySavings": 46.478333,
      "currentCost": 67.77599,
      "projectedCost": 66.48167,
      "projectedSavingsByCost": 1.2943289,
      "terminateRecommendation": false,
      "__typename": "RightsizingRecommendation"
    },
    "__typename": "RightsizingRecommendationEdge"
  },
  "index": 1
}
```

<Warning>All further steps in this workflow will be added inside this loop.</Warning>

### Generate opportunity ID

The first new step you'll need to add inside the loop will generate an ID for the current recommendation. CloudHealth doesn't provide this ID, so you'll need to generate it yourself. The ID will be used to save the recommendation in the OpenOps' preconfigured *Opportunities* table, track the status of the recommendation, and, most crucially, decide whether to send a Slack notification to the project owner.

While you could simplify the workflow greatly without tracking recommendations in an OpenOps table, you then wouldn't be able to select which notifications to send and which to ignore. As a result, project owners would potentially receive multiple notifications for the same recommendation, which would get annoying very soon.

Inside the loop in the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Text Operations** in the left pane, then click **Concatenate** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Opportunity ID_.

In the properties pane, under **Texts**, click **Add Item**. Click the new field to open the **Data Selector** view. Inside that view, expand **3. For each recommendation**, then **item**, then **node**, then **targetAsset**. Click **Insert** alongside the **id** entry:

![Selecting a targetAsset ID](/images/cloudhealth/opportunity-id-targetAsset-id.png)

Under **Texts**, click **Add Item** again to add a new field. Click the new field to open the **Data Selector** view again. Expand **3. For each recommendation**, then **item**, then **node**, then **targetAsset**. Click **Insert** alongside the **awsInstanceId** entry:

![Selecting a targetAsset AWS instance ID](/images/cloudhealth/opportunity-id-awsInstanceId.png)

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured text concatenation block](/images/cloudhealth/opportunity-id-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output should be a string that combines the two IDs that you've just added to the step's properties:

```text
6322302345294i-0fbc4dbf9ca0b46c0
```

### Look up the opportunity in the OpenOps table

Now that you have an opportunity ID, let's add a step that checks if the recommendation that has it already exists in the *Opportunities* table in OpenOps.

Inside the loop in the workflow graph, click **+** to add a new step.

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Get Records** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Find table entry for opportunity_.

In the **Configure** tab in the properties pane, under **Table**, select **Opportunities**.

Under **Fields to filter by**, click **Add Item**. In the new filter section:
* Under **Field name**, select **External Opportunity Id**.
* Under **Filter type**, select **Is equal**.
* In the **External Opportunity Id** field, open the **Data Selector** view and click **Insert** alongside the **4. Opportunity ID** entry.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured table lookup step](/images/cloudhealth/find-table-entry-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output will be an object representing the number of found table entries and the content of these entries. Since there are no existing entries for a new recommendation, here's the expected output:

```json
{
  "count": 0,
  "items": []
}
```

However, the structure of the output is different if the recommendation already exists in the table. Since the next step of the workflow will need to use a part of the output for an existing table record, let's add a sample output for the step.

Click **Sample output data** in the **Test** tab. In the **Output** area, paste the following JSON, then click **Apply**:

```json
{
  "count": 1,
  "items": [
    {
      "id": 48,
      "order": "1.00000000000000000000",
      "ID": "6cc0f15a-f3eb-4d77-b6b3-2f51eebbe8cf",
      "Status": {
        "id": 5,
        "value": "Created",
        "color": "grey"
      },
      "Opportunity Type": null,
      "Estimated savings USD per month": null,
      "Resource Id": null,
      "Workflow": null,
      "Service": null,
      "Region": null,
      "Account": null,
      "Owner": null,
      "Follow-up task": null,
      "Opportunity generator": null,
      "External Opportunity Id": "6322302345294i-0fbc4dbf9ca0b46c0",
      "Complexity": null,
      "Risk": null,
      "Opportunity details": null,
      "Snoozed until": null,
      "Resolution notes": null,
      "Creation time": "2025-09-22T13:44:52.980710Z",
      "Last modified time": "2025-09-22T13:44:52.980710Z"
    }
  ]
}
```

### Save table entry ID to OpenOps storage

You should now map the ID of the current recommendation to the ID of its entry in the *Opportunities* table, and save this mapping to OpenOps' built-in key-value storage. You'll need this later on in the workflow when you decide whether to send a notification to the project owner.

Inside the loop in the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Storage** in the left pane, then click **Put** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Save table record ID to storage_.

In the **Key** field, use **Data Selector** to select **4. Opportunity ID**.

In the **Value** field, open **Data Selector**, expand **5. Find table entry for opportunity**, then **items**, then **items[1]**. Click **Insert** alongside the uppercase **ID** entry:

![Selecting a table entry ID](/images/cloudhealth/find-table-entry-id.png)

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured storge step](/images/cloudhealth/save-table-entry-id-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output will be the value of the ID field in the *Opportunities* table entry that represents the current recommendation:

```text
6cc0f15a-f3eb-4d77-b6b3-2f51eebbe8cf
```

### Check if a table entry exists

When you run a published workflow, an entry for a CloudHealth recommendation may or may not already exist in the *Opportunities* table. What this workflow does next depends on whether the entry exists or not. To check this, you need to introduce a condition step next.

Inside the loop in the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Condition** in the left pane, then click **Condition** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _If no table entry for opportunity_.

Under **Continue If**, click the left field with a placeholder that reads _First value_. In the **Data Selector** view, expand **5. Find table entry for opportunity** and click **Insert** alongside the **count** entry.

In the combobox between the two fields, select **(Number) Is less than**.

In the right field, enter `1`.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured condition](/images/cloudhealth/table-entry-condition-added.png)

This condition should evaluate to `true` if there is no table entry for the current recommendation, and `false` if there is one.

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. Since you've added a sample output data for step five that contains a table entry, the test output will be `false`:

```json
{
  "condition": false
}
```

### If no table entry, create one

If the condition above evaluates to `true`, this means the *Opportunities* doesn't have a record for it. In this case, you need to create a new table entry and save its ID to storage for later use.

#### Create a new table entry

Inside the **True** branch of the condition, click **+** to add a new step.

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Add or Update Record** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Add table entry for opportunity_.

For the **Table** field, select **Opportunities**.

Leave the **Primary Key Value** field empty, letting OpenOps generate a unique ID for the new record.

Under **Fields to update**, click **Add Item**. In the new area:
* In the **Field name** dropdown, select **External Opportunity Id**.
* In the **External Opportunity Id** field, open the **Data Selector** view and click **Insert** alongside the **4. Opportunity ID** entry.

Click **Add Item** again to add a new field. In the new area:
* In the **Field name** dropdown, select **Status**.
* In the **Status** dropdown, select **Created**.

Here's what the **Configure** tab in the properties pane should now look like:

![A configured step to add a table entry](/images/cloudhealth/add-table-entry-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output represents a new entry in the *Opportunities* table:

```json
{
  "id": 49,
  "order": "2.00000000000000000000",
  "ID": "43bd78d2-18d9-4908-b035-c854364a19bd",
  "Status": {
    "id": 5,
    "value": "Created",
    "color": "grey"
  },
  "Opportunity Type": null,
  "Estimated savings USD per month": null,
  "Resource Id": null,
  "Workflow": null,
  "Service": null,
  "Region": null,
  "Account": null,
  "Owner": null,
  "Follow-up task": null,
  "Opportunity generator": null,
  "External Opportunity Id": "6322302345294i-0fbc4dbf9ca0b46c0",
  "Complexity": null,
  "Risk": null,
  "Opportunity details": null,
  "Snoozed until": null,
  "Resolution notes": null,
  "Creation time": "2025-09-22T15:05:23.232427Z",
  "Last modified time": "2025-09-22T15:05:23.232427Z"
}
```

#### Save table entry ID to storage

Now that you have a new table entry, you need to save its ID to OpenOps' built-in key-value storage.

Inside the **True** branch of the condition, click **+** to add a new step.

In the pop-up menu, select **Storage** in the left pane, then click **Put** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Update table record ID in storage_. You're using the word "update" because in a prior step, you've already created a key-value pair, but since no table record existed yet, its value was empty.

In the **Key** field, use **Data Selector** to select **4. Opportunity ID**.

In the **Value** field, open **Data Selector**, expand **8. Add table entry for opportunity**, then click **Insert** alongside the uppercase **ID** entry:

![Selecting the uppercase ID](/images/cloudhealth/selecting-uppercase-id.png)

Here's what the **Configure** tab in the properties pane should now look like:

![A configured step to update storage with table entry ID](/images/cloudhealth/update-storage-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output will be the value of the ID field in the *Opportunities* table entry that represents the current recommendation:

```text
43bd78d2-18d9-4908-b035-c854364a19bd
```

### If a table entry exists, check the status

You've just handled a case where a new table entry needs to be created, adding steps to the **True** branch of the condition step that we called _If no table entry for opportunity_.

If a table entry already exists, there's also something that needs to be done. Let's now add actions to the **False** branch of the condition.

#### Check if an existing table entry is in the "Created" state

Inside the **False** branch of the condition, click **+** to add a new step.

In the pop-up menu, select **Condition** in the left pane, then click **Condition** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Table entry exists but opportunity is marked as new_.

Under **Continue If**, click the left field. In the **Data Selector** view, expand **5. Find table entry for opportunity**, then **items**, then **items[1]**, then **Status**. Click **Insert** alongside the **value** entry:

![Selecting a status value](/images/cloudhealth/data-selector-status-value.png)

In the combobox between the two fields, select **(Text) Is**.

In the right field, enter `Created`.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured condition](/images/cloudhealth/table-entry-status-check-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**.

#### If the current status is "Created", update it

If a table entry for a recommendation already exists, but it's in the "Created" state, this means a project owner has been notified about this recommendation the last time the workflow was run but has not taken any action yet. In this case, you should change the status to avoid notifying the project owner again.

In the **True** branch of the _Table entry exists but opportunity is marked as new_ condition, click **+** to add a new step.

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Add or Update Record** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Change status of existing opportunity_.

For the **Table** field, select **Opportunities**.

In the **Primary Key Value** field, use **Data Selector** to expand **5. Find table entry for opportunity**, then **items**, then **items[1]**. Click **Insert** alongside the uppercase **ID** entry.

Under **Fields to update**, click **Add Item**. In the new area:
* In the **Field name** dropdown, select **Status**.
* In the **Status** dropdown, select **Under review**.

Here's what the **Configure** tab in the properties pane should now look like, along with the workflow graph:

![A configured step to update record status](/images/cloudhealth/nested-condition-ready.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output should represent the updated status of the existing table entry:

```json
{
  "id": 48,
  "order": "1.00000000000000000000",
  "ID": "6cc0f15a-f3eb-4d77-b6b3-2f51eebbe8cf",
  "Status": {
    "id": 9,
    "value": "Under review",
    "color": "pink"
  },
...
}
```

### Get the current date

You've now written all steps inside the outer **If no table entry for opportunity** condition. To create the next step, click **+** in the location on the workflow graph right after both branches of the condition merge:

![Creating a step after a completed condition](/images/cloudhealth/new-step-after-condition.png)

In the pop-up menu, select **Date Operations** in the left pane, then click **Get Current Date** in the right pane.

Keep the default settings in the **Configure** tab of the properties pane. Switch to the **Test** tab, then under **Step output**, click **Test Step**. The output should be the current date:

```text
2025-09-24
```

You will use this date in a later step when you decide whether to send a Slack notification for a previously snoozed recommendation.

### Get table ID for recommendation

Soon you'll need to decide if the project owner should be notified about the current CloudHealth recommendation. To prepare for this, you first need to fetch the ID of the table record for this recommendation.

Click **+** to add a new step.

In the pop-up menu, select **Storage** in the left pane, then click **Get** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Get table ID for opportunity_.

In the **Key** field, use **Data Selector** to select **4. Opportunity ID**. Keep **Default Value** blank and **Store Scope** at the default value.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured step to get a table ID](/images/cloudhealth/get-table-id-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The expected output is the ID of the current CloudHealth recommendation in the *Opportunities* table:

```text
43bd78d2-18d9-4908-b035-c854364a19bd
```

### Get table entry for recommendation

With the ID of the current CloudHealth recommendation in the *Opportunities* table, you can now read its full entry from the table.

Click **+** to add a new step.

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Get Records** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Get table entry for opportunity_.

In the **Table** field, select **Opportunities**.

Under **Fields to filter by**, click **Add Item**. In the new area:
* For **Field name**, select **ID**.
* For **Filter type**, select **Is equal**.
* In the **ID** field, use **Data Selector** to select **13. Get table ID for opportunity**.

Here's what the new step in the workflow graph and the **Configure** tab in its properties pane should now look like:

![A configured step to read a table record](/images/cloudhealth/get-table-entry-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output should represent the current recommendation's table entry:

```json
{
  "count": 1,
  "items": [
    {
      "id": 49,
      "order": "2.00000000000000000000",
      "ID": "43bd78d2-18d9-4908-b035-c854364a19bd",
      "Status": {
        "id": 5,
        "value": "Created",
        "color": "grey"
      },
    ...
    }
  ]
}
```

### Decide to skip or notify the project owner

You now have all the information you need to decide whether to notify the project owner about the current recommendation over Slack. To make this decision, you'll need to introduce a condition step.

In the workflow graph, click **+** to add a new step.

In the pop-up menu, select **Condition** in the left pane, then click **Condition** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Skip or notify?_.

You want to notify the project owner in two cases:
* If this is a new recommendation, as evidenced by the "Created" state.
* If the project owner has been notified of the current recommendation in the past, chose to snooze it, and the snooze date has passed.

Let's define these two cases. Under **Continue If**, click the left field. In **Data Selector**, expand **14. Get table entry for opportunity**, then **items**, then **items[1]**, then **Status**. Click **Insert** alongside the **value** entry:

![Selecting a status value](/images/cloudhealth/skip-or-notify-selecting-status-value.png)

In the combobox between the two fields, select **(Text) Is**.

In the right field, enter `Created`.

Click **+ Or**. In the new area, click the left field.  In **Data Selector**, expand **14. Get table entry for opportunity**, then **items**, then **items[1]**. Scroll down and click **Insert** alongside the **Snoozed until** entry.

In the combobox between the two fields, select **(Date) Is before**.

In the right field, use **Data Selector** to insert **12. Get Current Date**.

The new step in the workflow graph and the **Configure** tab in its properties pane should now look like this:

![A configured condition step](/images/cloudhealth/skip-or-notify-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**.

<Warning>All further steps in this workflow will be added inside the **True** branch of this condition.</Warning>

### Get asset perspectives from CloudHealth

In case the project owner should be notified, you need to add several preparatory steps in the **True** branch of the condition, followed by steps to send a Slack notification and handle the project owner's response. Let's start with making a call to the CloudHealth API to determine which project the AWS instance related to the current recommendation belongs to.

In the **True** branch of the *Skip or notify?* condition, click **+** to add a new step.

In the pop-up menu, select **CloudHealth** in the left pane, then click **Get Asset Perspectives** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Get project and more perspectives_.

Under **API Key** in the properties pane, select your existing CloudHealth connection.

Under **Asset Type**, select **AwsInstance**.

Under **Fields to filter by**, click **Add Item**. In the new area:
* Under **Field name**, select **instance_id**.
* In the **Value to search for** field, use **Data Selector** to expand **3. For each recommendation**, then **item**, then **node**, then **targetAsset**. Click **Insert** alongside the **awsInstanceId** entry:
    ![Selecting AWS instance ID](/images/cloudhealth/selecting-awsinstanceid.png)

Here's what the new step in the workflow graph and the **Configure** tab in its properties pane should now look like:

![A configured step to get asset perspectives from CloudHealth](/images/cloudhealth/asset-perspectives-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output is a list of asset perspectives for the given AWS instance ID, including the project it belongs to:

```json
[
  {
    "asset": {
      "instance_id": "i-0fbc4dbf9ca0b46c0",
      "name": "jeff-test-2-ng-2-Node",
      "state": "running",
      ...
    },
    "perspectives": {
      "Project": "Opencart",
      ...
    }
  }
]
```

### Get owner by project

Now that you know which project the recommendation belongs to, you can find out who owns the project.

Click **+** to add a new step.

In the pop-up menu, select **OpenOps Tables** in the left pane, then click **Get Records** in the right pane.

At the top of the new step's properties pane, click **Edit Step Name** and rename the step to _Get owner by project_.

In the **Table** field, select **CloudHealth project-owner mapping**.

Under **Fields to filter by**, click **Add Item**. In the new area:
* For **Field name**, select **CloudHealth project**.
* For **Filter type**, select **Is equal**.
* In the **CloudHealth project** field, use **Data Selector** to expand **16. Get project and more perspectives**, then **16. Get project and more perspectives[1]**, then **perspectives**. Click **Insert** alongside the **Project** entry:
    ![Selecting a project](/images/cloudhealth/selecting-project.png)

Here's what the new step in the workflow graph and the **Configure** tab in its properties pane should now look like:

![A configured step to get owner by project](/images/cloudhealth/owner-by-project-added.png)

Click the **Test** tab in the properties pane, then under **Step output**, click **Test Step**. The output is a project-owner mapping table entry for the given project:

```json
{
  "count": 1,
  "items": [
    {
      "id": 7,
      "order": "2.00000000000000000000",
      "CloudHealth project": "Opencart",
      "Owner email": "your@email.here"
    }
  ]
}
```

## Update the project-owner mapping table with real owner emails

Click **Tables** in the left-side menu to open the table editor. In the list of tables under **OpenOps Dataset**, click **CloudHealth project-owner mapping**.

Since both the project-owner mapping and rightsizing workflows are now ready, you can now update the table with real project owner emails (make sure that these emails are also used in your Slack installation). Once you do, the rightsizing workflow will send Slack notifications to the project owners.
