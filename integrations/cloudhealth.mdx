---
title: 'Integrating CloudHealth with OpenOps'
description: 'Using CloudHealth data in an OpenOps workflow'
icon: 'heart-pulse'
---

## Webinar notes

Rita starts at 13:50
Action: get recommendations from CloudHealth
Recommendation type: EC2 rightsizing
Evaluation duration: last 7 days
Limit number of recommendations to 1 (why?)

## What is CloudHealth?

## Why use CloudHealth?

## How does CloudHealth integrate with OpenOps?

## What this tutorial will cover

This tutorial guides you step-by-step to create the "CloudHealth Rightsizing Recommendations" workflow in OpenOps. This workflow automates fetching AWS EC2 rightsizing recommendations from CloudHealth, notifies owners via Slack, and optionally creates JIRA tickets or manages snooze/exempt actions.

The workflow is going to be:

1. Trigger: Scheduled to run every day at midnight UTC, excluding weekends.
2. Call CloudHealth block to get rightsizing recommendations for AWS EC2 instances from the last 7 days, limited to one recommendation.
3. Loop over the list of rightsizing recommendations returned. For each recommendation:
    1. Fetch asset perspectives from CloudHealth for the target AWS instance.
    2. Query the "Project perspective owners" table to get owner information based on the project perspective.
    3. Format the projected monthly savings value to 2 decimal places.
    4. Run custom code to extract the AWS region from the instance DNS.
    5. Send a Slack message with the rightsizing opportunity details and three action buttons: "Open Jira ticket", "Snooze", "Exempt".
    6. Split the flow based on the Slack action selected:
        1. If "Open Jira ticket":
            1. Create a JIRA issue for the opportunity
            2. Sends a Slack confirmation message.
        2. If "Snooze":
            1. Calculate the next Monday date
            2. Update the opportunity status to "Snoozed" with the snooze date.
        3. If "Exempt":
             1. Tag the asset as exempt in CloudHealth.


## Prerequisites

You will need a CloudHealth account configured to provide recommendations for AWS EC2 instances.

On several steps of the tutorial, you'll also need to create OpenOps connections to several services:
- **CloudHealth**: API credentials to access CloudHealth data.
- **Slack**: Bot token with permissions to send messages and request actions.
- **Jira**: API credentials with permissions to create issues.

## Steps

### Create a new workflow

In your OpenOps instance, click the **+ New Workflow** button on the top right.

OpenOps will open its workflow editor with a new untitled workflow that initially only contains an empty trigger step:

![A new workflow in OpenOps](/images/cloudhealth/empty-workflow.png)

On the top left, click the down arrow next to the workflow name, then click **Rename**, and rename the workflow to _CloudHealth Rightsizing Recommendations_.

### Configure the trigger to run every working day

The first thing that needs to be done is to configure your workflow to run on a schedule.

In the workflow editor, click the trigger step. When a drop-down with types of triggers opens, select **Schedule**, then **Every Day**.

After selecting the trigger type and frequency, you will see the trigger step's properties pane on the right. In many cases, you will want to modify the trigger's settings, but for this tutorial, keep the defaults. With the default trigger settings, your workflow will run every day, excluding weekends, at midnight UTC.

In the bottom right pane, under **Step output**, click **Load Data**. This way, you're testing your step, and going forward, you'll need to test all steps before you can test the entire workflow. While in the case of a trigger this looks more like a formality, in many cases testing individual steps will help you spot and fix configuration errors quickly.

Here's what your workflow should look like at this point:

![A configured and tested trigger](/images/cloudhealth/trigger-added.png)

### Fetch rightsizing recommendations from CloudHealth

Now is the time to add the first action step. Since the workflow is centered around processing recommendations from CloudHealth, let's start with that.

In the workflow graph, under the trigger, click the **+** button to add a new step.

In the pop-up menu, scroll down to and click **CloudHealth**. In the list of CloudHealth-related actions, select **Get Recommendations**:

![Selecting a CloudHealth action](/images/cloudhealth/selecting-cloudhealth-action.png)

This adds a new step to the workflow graph and displays the action's properties pane on the right. You'll now need to configure the action.

First, in the properties pane, under **API Key**, click **Select a connection**, then **Create Connection**. This will open a new dialog that looks like this:

![Creating a CloudHealth connection](/images/cloudhealth/create-cloudhealth-connection.png)

In the dialog, you need to enter your CloudHealth API key. If you don't have it at hand, follow the instructions in the dialog to generate an API key. Once you have the key, paste it into the **API Key** field and click **Save**.

After the dialog closes, back in the properties pane, configure the remaining action properties:
* Under **Recommendation Type**, select **EC2 Rightsizing**.
* Under **Evaluation Duration**, select **Last 7 Days**.
* Under **Limit**, set the value to `3` to retrieve the top 3 recommendations.

Under **Step output**, click **Test Step**. This will test the action and display the results in the bottom right pane.

Your workflow should now look like this:

![A configured CloudHealth action](/images/cloudhealth/cloudhealth-action-added.png)

### Loop over recommendations

CloudHealth returns a list of recommendations, but we only want to process one at a time. To do this, let's use a **Loop on Items** block.

In the workflow graph, click the **+** button to add a new step.

In the pop-up menu, select **Loop on Items** in the left pane, then click **Loop on Items** in the right pane. This adds a new step to the workflow graph and displays the loop's properties pane on the right.

In the properties pane, click the **Items** field. In the **Data Selector** view that opens, expand the **2. Get Recommendations** entry, then expand **rightsizingRecommendations**, and click **Insert** alongside the **edges** entry:

![Selecting items to loop over](/images/cloudhealth/data-selector-edges.png)

This will add the **edges** entry to the **Items** field in the properties pane, ensuring that OpenOps loops over this particular array in the list of CloudHealth recommendations.

In the properties pane, under **Step output**, click **Test Step**. After testing, your workflow should look like this:

![A configured Loop on Items block](/images/cloudhealth/loop-added.png)

#### Get asset perspectives from CloudHealth

- Inside the loop, add a **Block** with `@openops/block-cloudhealth`.
- Use the action `cloudhealth_get_asset_perspectives`.
- Input:
  - `auth`: CloudHealth connection.
  - `assetType`: `AwsInstance`.
  - `fields`: Pass the instance ID from the current item: `{{step_2['item']['node']['targetAsset']['awsInstanceId']}}`.
- This enriches the recommendation with asset metadata and perspectives.

#### Query project owner from an OpenOps table

- Add a **Block** with `@openops/block-openops-tables`.
- Use the action `get_records`.
- Configure inputs:
  - `tableName`: `Project perspective owners`.
  - `filters`: Filter by project name equal to `{{step_13[0]['perspectives']['Project']}}`.
- This fetches the owner email and other details for the project.

#### Format projected monthly savings

- Add a **Block** with `@openops/block-math-helper`.
- Use the action `truncate_math`.
- Input:
  - `number`: `{{step_2['item']['node']['projectedMonthlySavings']}}`.
  - `numberOfDecimalPlaces`: `2`.
- This formats the savings value for display.

#### Extract AWS region from DNS

- Add a **Code** block.
- Input:
  - `dns`: `{{step_13[0]['asset']['dns']}}`.
- Use this JavaScript code to extract the AWS region from the DNS string:

```javascript
export const code = async (inputs) => {
  const dns = typeof inputs['dns'] === 'string' ? inputs['dns'] : '';
  const parts = dns.split('.');
  const region = parts.length > 1 ? parts[1] : '';
  return region;
};
```

#### Send a Slack notification

- Add a **Block** with `@openops/block-slack`.
- Use the action `request_action_message`.
- Configure inputs:
  - `auth`: Slack connection.
  - `text`: Compose a message including:
    - Account name
    - Instance ID and name
    - Projected monthly savings
    - Owner email
    - Cost center perspective
    - Link to CloudHealth resource details
  - Include action buttons:
    - Open JIRA ticket (primary)
    - Snooze for 7 days
    - Exempt (danger)
  - Set `timeoutInDays` to 3.
  - Provide a Slack conversation ID for responses.
- This notifies the owner and collects their response.

#### Handle Slack action with a split block

- Add a **Split** block to branch based on Slack action:
  - **JIRA branch**:
    - Add a **Block** with `@openops/block-jira-cloud`.
    - Use `create_issue` action.
    - Configure issue details with opportunity info.
    - Follow with a Slack message confirming issue creation.
  - **Snooze branch**:
    - Add a **Block** with `@openops/block-date-helper`.
    - Use `next_day_of_week` to calculate next Monday.
    - Update the `Opportunities` table record to set status to "Snoozed" and snooze date.
  - **Exempt branch**:
    - Add a **Block** with `@openops/block-cloudhealth`.
    - Use `cloudhealth_tag_asset` to tag the asset as exempt with `ExemptByOpenOps=true`.
