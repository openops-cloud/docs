---
title: 'Integrating CloudHealth with OpenOps'
description: 'Using CloudHealth data in an OpenOps workflow'
icon: 'heart-pulse'
---

## Webinar notes

Rita starts at 13:50
Action: get recommendations from CloudHealth
Recommendation type: EC2 rightsizing
Evaluation duration: last 7 days
Limit number of recommendations to 1 (why?)

## What is CloudHealth?

## Why use CloudHealth?

## How does CloudHealth integrate with OpenOps?

## What this tutorial will cover

* What kind of workflow we're going to author
* What are the benefits of this workflow

The workflow is going to be:

1. Trigger: Scheduled to run every day at midnight UTC, excluding weekends.
2. Call CloudHealth block to get rightsizing recommendations for AWS EC2 instances from the last 7 days, limited to one recommendation.
3. Loop over the list of rightsizing recommendations returned. For each recommendation:
    1. Fetch asset perspectives from CloudHealth for the target AWS instance.
    2. Query the "Project perspective owners" table to get owner information based on the project perspective.
    3. Format the projected monthly savings value to 2 decimal places.
    4. Run custom code to extract the AWS region from the instance DNS.
    5. Send a Slack message with the rightsizing opportunity details and three action buttons: "Open Jira ticket", "Snooze", "Exempt".
    6. Split the flow based on the Slack action selected:
        1. If "Open Jira ticket":
            1. Create a JIRA issue for the opportunity
            2. Sends a Slack confirmation message.
        2. If "Snooze":
            1. Calculate the next Monday date
            2. Update the opportunity status to "Snoozed" with the snooze date.
        3. If "Exempt":
             1. Tag the asset as exempt in CloudHealth.


## Prerequisites

A CloudHealth account configured to provide recommendations for AWS EC2 instances.

## Steps

# Tutorial: Authoring the "CloudHealth Rightsizing Recommendations" Workflow in OpenOps

This tutorial guides you step-by-step to create the "CloudHealth Rightsizing Recommendations" workflow in OpenOps. This workflow automates fetching AWS EC2 rightsizing recommendations from CloudHealth, notifies owners via Slack, and optionally creates JIRA tickets or manages snooze/exempt actions.

---

## Prerequisites

Before starting, ensure you have the following OpenOps connections configured:

- **CloudHealth**: API credentials to access CloudHealth data.
- **Slack**: Bot token with permissions to send messages and request actions.
- **Jira**: API credentials with permissions to create issues.
- **OpenOps Tables**: Access to tables named `Project perspective owners` and `Opportunities`.

---

## Step 1: Create a Scheduled Trigger

- Add a **Trigger** block using the official `@openops/block-schedule` block.
- Configure it to run **every day at 00:00 UTC**, excluding weekends.
- This ensures the workflow runs daily to check for new rightsizing opportunities.

---

## Step 2: Fetch Rightsizing Recommendations from CloudHealth

- Add a **Block** using the official `@openops/block-cloudhealth` block.
- Select the action `cloudhealth_get_recommendations`.
- Configure inputs:
  - `auth`: Use the CloudHealth connection.
  - `limit`: Set to `1` (or adjust as needed).
  - `evaluationDuration`: Set to `LAST_7_DAYS`.
  - `recommendationType`: Set to `AWS_EC2`.
- This block fetches recent EC2 rightsizing recommendations.

---

## Step 3: Loop Over Recommendations

- Add a **Loop on Items** block.
- Set the items to loop over as `{{step_17['rightsizingRecommendations']['edges']}}` (replace `step_17` with your fetch block name).
- This allows processing each recommendation individually.

---

## Step 4: Get Asset Perspectives from CloudHealth

- Inside the loop, add a **Block** with `@openops/block-cloudhealth`.
- Use the action `cloudhealth_get_asset_perspectives`.
- Input:
  - `auth`: CloudHealth connection.
  - `assetType`: `AwsInstance`.
  - `fields`: Pass the instance ID from the current item: `{{step_2['item']['node']['targetAsset']['awsInstanceId']}}`.
- This enriches the recommendation with asset metadata and perspectives.

---

## Step 5: Query Project Owner from OpenOps Table

- Add a **Block** with `@openops/block-openops-tables`.
- Use the action `get_records`.
- Configure inputs:
  - `tableName`: `Project perspective owners`.
  - `filters`: Filter by project name equal to `{{step_13[0]['perspectives']['Project']}}`.
- This fetches the owner email and other details for the project.

---

## Step 6: Format Projected Monthly Savings

- Add a **Block** with `@openops/block-math-helper`.
- Use the action `truncate_math`.
- Input:
  - `number`: `{{step_2['item']['node']['projectedMonthlySavings']}}`.
  - `numberOfDecimalPlaces`: `2`.
- This formats the savings value for display.

---

## Step 7: Extract AWS Region from DNS (Custom Code)

- Add a **Code** block.
- Input:
  - `dns`: `{{step_13[0]['asset']['dns']}}`.
- Use this JavaScript code to extract the AWS region from the DNS string:

```javascript
export const code = async (inputs) => {
  const dns = typeof inputs['dns'] === 'string' ? inputs['dns'] : '';
  const parts = dns.split('.');
  const region = parts.length > 1 ? parts[1] : '';
  return region;
};
```

## Step 8: Send Slack Notification with Actions

- Add a **Block** with `@openops/block-slack`.
- Use the action `request_action_message`.
- Configure inputs:
  - `auth`: Slack connection.
  - `text`: Compose a message including:
    - Account name
    - Instance ID and name
    - Projected monthly savings
    - Owner email
    - Cost center perspective
    - Link to CloudHealth resource details
  - Include action buttons:
    - Open JIRA ticket (primary)
    - Snooze for 7 days
    - Exempt (danger)
  - Set `timeoutInDays` to 3.
  - Provide a Slack conversation ID for responses.
- This notifies the owner and collects their response.

---

## Step 9: Handle Slack Action with Split Block

- Add a **Split** block to branch based on Slack action:
  - **JIRA branch**:
    - Add a **Block** with `@openops/block-jira-cloud`.
    - Use `create_issue` action.
    - Configure issue details with opportunity info.
    - Follow with a Slack message confirming issue creation.
  - **Snooze branch**:
    - Add a **Block** with `@openops/block-date-helper`.
    - Use `next_day_of_week` to calculate next Monday.
    - Update the `Opportunities` table record to set status to "Snoozed" and snooze date.
  - **Exempt branch**:
    - Add a **Block** with `@openops/block-cloudhealth`.
    - Use `cloudhealth_tag_asset` to tag the asset as exempt with `ExemptByOpenOps=true`.

---
